package com.example.frontend.controller;

import com.example.frontend.util.SessionUtil;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import javax.servlet.http.HttpSession;
import java.util.Collections;
import java.util.List;
import java.util.Map;

@Controller
@RequestMapping("/users-ui")
public class UserUIController {

    @Value("${backend.base.url}")
    private String backendBaseUrl;        // yahi pe http://localhost:8081 aayega

    private final RestTemplate restTemplate = new RestTemplate();

    // ========== REGISTER ==========
    @GetMapping("/register")
    public String showRegister() {
        return "user-register";
    }

    @PostMapping("/register")
    public String doRegister(@RequestParam Map<String,String> params, Model model) {
        try {
            Map<String, Object> body = new java.util.HashMap<>();

            body.put("firstName",  params.getOrDefault("firstName", ""));
            body.put("lastName",   params.getOrDefault("lastName", ""));
            body.put("userName",   params.getOrDefault("userName", ""));
            body.put("password",   params.getOrDefault("password", ""));
            body.put("email",      params.getOrDefault("email", ""));
            body.put("mobileNo",   params.getOrDefault("mobileNo", ""));

            body.put("dob", params.getOrDefault("dob", null));
            body.put("accountType", params.getOrDefault("accountType", null));
            body.put("cheqFacil",   params.getOrDefault("cheqFacil", null));

            String amountStr = params.get("amount");
            if (amountStr != null && !amountStr.isBlank()) {
                try {
                    body.put("amount", Double.parseDouble(amountStr));
                } catch (NumberFormatException e) {
                    body.put("amount", null);
                }
            } else {
                body.put("amount", null);
            }

            body.put("address1", params.getOrDefault("address1", null));
            body.put("address2", params.getOrDefault("address2", null));
            body.put("city",     params.getOrDefault("city", null));
            body.put("state",    params.getOrDefault("state", null));
            body.put("zipCode",  params.getOrDefault("zipCode", null));
            body.put("country",  params.getOrDefault("country", null));

            // user initially INACTIVE
            body.put("status", "INACTIVE");

            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);

            HttpEntity<Map<String,Object>> entity = new HttpEntity<>(body, headers);

            restTemplate.postForEntity(backendBaseUrl + "/users/add", entity, String.class);

            model.addAttribute("message", "Registered successfully, please wait for admin approval.");
        } catch (Exception e) {
            model.addAttribute("message", "Unexpected error: " + e.getMessage());
        }
        return "user-register";
    }

    // ========== LOGIN PAGE ==========
    @GetMapping("/login")
    public String showLogin() {
        return "user-login";
    }

    // ========== LOGIN + DASHBOARD DATA ==========
    @PostMapping("/login")
    public String doLogin(@RequestParam String userName,
                          @RequestParam String password,
                          HttpSession session,
                          Model model) {

        try {
            // 1) backend pe /users/login hit
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);

            String json = String.format("{\"userName\":\"%s\",\"password\":\"%s\"}", userName, password);
            HttpEntity<String> entity = new HttpEntity<>(json, headers);

            ResponseEntity<String> resp =
                    restTemplate.postForEntity(backendBaseUrl + "/users/login", entity, String.class);

            if (resp.getStatusCode().is2xxSuccessful()) {

                // session me user store
                Integer userId = null; // agar backend response se id milti ho to yahan parse karke set kar sakte ho
                SessionUtil.setUser(session, "USER", userId, userName);

                model.addAttribute("message", "Login successful");

                // 2) SAARE APPS LAO: GET http://localhost:8081/apps
                ResponseEntity<List> appsResp =
                        restTemplate.exchange(
                                backendBaseUrl + "/apps",
                                HttpMethod.GET,
                                null,
                                List.class
                        );

                List<Map<String, Object>> apps = appsResp.getBody();
                if (apps == null) {
                    apps = Collections.emptyList();
                }

                // 3) downloads list abhi nahi hai to empty bhej rahe hain
                model.addAttribute("apps", apps);                       // user-dashboard.jsp me ${apps}
                model.addAttribute("downloads", Collections.emptyList()); // ${downloads}

                // 4) user name bhi dashboard me use ho raha hai
                session.setAttribute("userName", userName);

                return "user-dashboard";

            } else {
                model.addAttribute("error", "Login failed: " + resp.getBody());
                return "user-login";
            }

        } catch (Exception e) {
            model.addAttribute("error", "Error: " + e.getMessage());
            return "user-login";
        }
    }

    @PostMapping("/apps/{appId}/download")
    public String downloadApp(@PathVariable Integer appId,
                              HttpSession session,
                              Model model) {

        // login check
        String userName = (String) session.getAttribute("userName");
        if (userName == null) {
            model.addAttribute("error", "Please login first");
            return "user-login";
        }

        try {
            // ====== BACKEND KO HIT KARO (user + appId) ======
            // yahan apne backend ka correct URL laga dena
            // example: POST http://localhost:8081/downloads
            Map<String, Object> body = new java.util.HashMap<>();
            body.put("userName", userName);
            body.put("appId", appId);

            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            HttpEntity<Map<String,Object>> entity = new HttpEntity<>(body, headers);

            restTemplate.postForEntity(backendBaseUrl + "/downloads", entity, String.class);

            model.addAttribute("message", "App downloaded successfully.");

        } catch (Exception e) {
            model.addAttribute("error", "Failed to download app: " + e.getMessage());
        }

        // ====== Apps list dubara load karo, taaki table fill rahe ======
        try {
            ResponseEntity<List> appsResp =
                    restTemplate.exchange(
                            backendBaseUrl + "/apps",
                            HttpMethod.GET,
                            null,
                            List.class
                    );
            List<Map<String, Object>> apps = appsResp.getBody();
            if (apps == null) apps = java.util.Collections.emptyList();
            model.addAttribute("apps", apps);
        } catch (Exception e) {
            model.addAttribute("apps", java.util.Collections.emptyList());
            model.addAttribute("error", "Cannot load apps: " + e.getMessage());
        }

        
        model.addAttribute("downloads", java.util.Collections.emptyList());

        return "user-dashboard";
    }

}
