package com.example.frontend.controller;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;
import org.springframework.http.*;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;

import javax.servlet.http.HttpSession;

@Controller
@RequestMapping("/owners-ui")
public class OwnerUIController {

    // Login page dikhane wala GET
    @GetMapping("/login")
    public String showOwnerLogin(Model model) {
        // JSP: OwnerLogin.jsp
        return "OwnerLogin";
    }

    // ðŸ”´ Yahi ek hi POST /owners-ui/login method rahega
    @PostMapping("/login")
    public String doLogin(@RequestParam("userName") String userName,
                          @RequestParam("password") String password,
                          HttpSession session,
                          Model model,
                          RedirectAttributes redirectAttributes) {

        // Backend app-service ka owner login API
        // ðŸ‘‰ Is URL ko apne setup ke hisaab se change kar lena:
        //    - agar Gateway use kar rahe ho to gateway ka URL
        //    - agar direct app-service pe ho to uska host:port
        String loginUrl = "http://localhost:8081/owners/login";

        RestTemplate restTemplate = new RestTemplate();

        // form-data bhej rahe hain (userName, password)
        MultiValueMap<String, String> form = new LinkedMultiValueMap<>();
        form.add("userName", userName);
        form.add("password", password);

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);

        HttpEntity<MultiValueMap<String, String>> requestEntity =
                new HttpEntity<>(form, headers);

        try {
            ResponseEntity<String> response =
                    restTemplate.postForEntity(loginUrl, requestEntity, String.class);

            if (response.getStatusCode().is2xxSuccessful()) {
                // login success
                session.setAttribute("loggedInOwner", userName);

                // dashboard me username query param se bhej denge
                redirectAttributes.addAttribute("userName", userName);
                return "redirect:/owners-ui/dashboard";
            } else if (response.getStatusCode().value() == 401) {
                // wrong username/password
                model.addAttribute("message", "Invalid username or password");
                return "OwnerLogin";
            } else {
                model.addAttribute("message", "Login service unavailable");
                return "OwnerLogin";
            }

        } catch (Exception ex) {
            ex.printStackTrace();
            model.addAttribute("message", "Something went wrong during login");
            return "OwnerLogin";
        }
    }

    // âœ… Owner dashboard
    @GetMapping("/dashboard")
    public String ownerDashboard(@RequestParam("userName") String userName,
                                 Model model,
                                 HttpSession session) {

        // Optional: session check
        Object loggedIn = session.getAttribute("loggedInOwner");
        if (loggedIn == null || !userName.equals(loggedIn.toString())) {
            // session nahi hai / mismatch, to login pe bhej do
            return "redirect:/owners-ui/login";
        }

        model.addAttribute("ownerUserName", userName);
        return "owner-dashboard";   // JSP: owner-dashboard.jsp
    }

    // Optional: logout
    @GetMapping("/logout")
    public String logout(HttpSession session) {
        session.invalidate();
        return "redirect:/owners-ui/login";
    }
}
