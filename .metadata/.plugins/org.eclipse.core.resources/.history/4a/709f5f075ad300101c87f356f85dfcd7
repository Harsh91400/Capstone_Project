package com.example.frontend.controller;

import com.example.frontend.util.SessionUtil;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;
import org.springframework.http.*;

import javax.servlet.http.HttpSession;
import java.util.List;
import java.util.Map;

@Controller
@RequestMapping("/users-ui")
public class UserUIController {

    private final RestTemplate restTemplate;
    private final String backendBase;

    public UserUIController(RestTemplate restTemplate, @Value("${backend.base.url}") String backendBase) {
        this.restTemplate = restTemplate;
        this.backendBase = backendBase;
    }

    @GetMapping("/register")
    public String showRegister() {
        return "user-register";
    }

    @PostMapping("/register")
    public String doRegister(@RequestParam Map<String,String> params, Model model) {
        try {
            // Body map jisme sab fields dalenge
            Map<String, Object> body = new java.util.HashMap<>();

            // Basic details
            body.put("firstName",  params.getOrDefault("firstName", ""));
            body.put("lastName",   params.getOrDefault("lastName", ""));
            body.put("userName",   params.getOrDefault("userName", ""));
            body.put("password",   params.getOrDefault("password", ""));
            body.put("email",      params.getOrDefault("email", ""));
            body.put("mobileNo",   params.getOrDefault("mobileNo", ""));

            // Dates (string format hi bhej rahe hain, backend parse karega)
            body.put("dob", params.getOrDefault("dob", null));
            // dateOfOpen backend set kare to yahan se bhejne ki zaroorat nahi

            // Account details
            body.put("accountType", params.getOrDefault("accountType", null));
            body.put("cheqFacil",   params.getOrDefault("cheqFacil", null));

            String amountStr = params.get("amount");
            if (amountStr != null && !amountStr.isBlank()) {
                try {
                    body.put("amount", Double.parseDouble(amountStr));
                } catch (NumberFormatException e) {
                    body.put("amount", null);
                }
            } else {
                body.put("amount", null);
            }

            // Address
            body.put("address1", params.getOrDefault("address1", null));
            body.put("address2", params.getOrDefault("address2", null));
            body.put("city",     params.getOrDefault("city", null));
            body.put("state",    params.getOrDefault("state", null));
            body.put("zipCode",  params.getOrDefault("zipCode", null));
            body.put("country",  params.getOrDefault("country", null));

            // Status
            //body.put("status", params.getOrDefault("status", "ACTIVE"));
            body.put("status", "INACTIVE");
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);

            HttpEntity<Map<String,Object>> entity = new HttpEntity<>(body, headers);

            ResponseEntity<String> resp =
                    restTemplate.postForEntity(backendBase + "/users/add", entity, String.class);

            model.addAttribute("message", "Registered successfully..."); //resp.getBody()
        } catch (org.springframework.web.client.HttpStatusCodeException e) {
            String body = e.getResponseBodyAsString();
            if (body != null && body.contains("EMAIL")) {
                model.addAttribute("message", "This email is already registered. Please use a different email.");
            } else {
                model.addAttribute("message", "Error from server: " + e.getStatusCode());
            }
        } catch (Exception e) {
            model.addAttribute("message", "Unexpected error: " + e.getMessage());
        }
        return "user-register";
    }


    @GetMapping("/login")
    public String showLogin() { return "user-login"; }

    @PostMapping("/login")
    public String doLogin(@RequestParam String userName, @RequestParam String password, HttpSession session, Model model) {
        try {
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            String json = String.format("{\"userName\":\"%s\",\"password\":\"%s\"}", userName, password);
            HttpEntity<String> entity = new HttpEntity<>(json, headers);
            ResponseEntity<String> resp = restTemplate.postForEntity(backendBase + "/users/login", entity, String.class);
            if(resp.getStatusCode().is2xxSuccessful()) {
                Integer userId = null;
                SessionUtil.setUser(session, "USER", userId, userName);
                model.addAttribute("message", "Login successful");
            } else {
                model.addAttribute("message", "Login failed: " + resp.getBody());
            }
        } catch(Exception e) {
            model.addAttribute("message", "Error: " + e.getMessage());
        }
        return "user-deshboard";
    }

    @GetMapping("/all")
    public String showAllUsers(Model model, HttpSession session) {
        try {
            ResponseEntity<List> resp = restTemplate.exchange(backendBase + "/users/all", HttpMethod.GET, null, List.class);
            model.addAttribute("users", resp.getBody());
        } catch(Exception e) {
            model.addAttribute("users", List.of());
            model.addAttribute("error", "Cannot load users: " + e.getMessage());
        }
        return "users";
    }

    @GetMapping("/{id}")
    public String userById(@PathVariable("id") Integer id, Model model) {
        try {
            ResponseEntity<Map> resp = restTemplate.getForEntity(backendBase + "/users/" + id, Map.class);
            model.addAttribute("user", resp.getBody());
        } catch(Exception e) {
            model.addAttribute("error", "Cannot load user: " + e.getMessage());
        }
        return "user-detail";
    }
}
